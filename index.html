<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>GymShop</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f8fafc; color:#0f172a; }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#0f172a; color:white; }
    .brand { font-weight:900; }
    nav a { color:white; margin-left:12px; text-decoration:none; }
    main { max-width:1200px; margin:0 auto; padding:20px; }

    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px; }
    .card { position:relative; border:1px solid #e2e8f0; border-radius:12px; padding:12px; background:white; cursor:pointer }
    .price { font-weight:900; font-size:18px; }
    .small { font-size:12px; color:#64748b; }
    .img { height:160px; background:#e2e8f0; border-radius:10px; margin-bottom:8px; display:flex; align-items:center; justify-content:center; overflow:hidden }
    .img img { width:100%; height:100%; object-fit:cover }

    /* Product pick checkbox (top-right on card) */
    .pickwrap { position:absolute; top:10px; right:10px; z-index:2 }
    .pick { width:22px; height:22px; border-radius:6px; border:1px solid #cbd5e1; appearance:none; background:#fff; display:inline-grid; place-content:center; cursor:pointer }
    .pick::before { content:""; width:14px; height:14px; transform:scale(0); transition:120ms transform ease-in-out; background:#0f172a; clip-path:polygon(14% 44%,0 59%,37% 96%,100% 22%,85% 8%,37% 71%); }
    .pick:checked { border-color:#0f172a; }
    .pick:checked::before { transform:scale(1); }

    /* Modal (product) */
    .modal { position:fixed; inset:0; background:rgba(2,6,23,.75); display:none; align-items:center; justify-content:center; padding:16px; z-index:50 }
    .modal.open { display:flex }
    .box { width:min(1000px,100%); background:#fff; color:#0f172a; border-radius:16px; overflow:hidden; display:grid; grid-template-columns:1.2fr 1fr; border:1px solid #e2e8f0 }
    @media (max-width:900px){ .box { grid-template-columns:1fr } }
    .gal { position:relative; padding:12px; border-right:1px solid #e2e8f0 }
    .hero { height:420px; background:#f1f5f9; border-radius:12px; border:1px solid #e2e8f0; display:flex; align-items:center; justify-content:center; overflow:hidden }
    .hero img { width:100%; height:100%; object-fit:contain }
    .thumbs { margin-top:8px; display:flex; gap:8px; overflow-x:auto; padding-bottom:8px }
    .thumbs img { width:80px; height:80px; border-radius:10px; border:1px solid #e2e8f0; object-fit:cover; opacity:.9; cursor:pointer }
    .thumbs img.active { outline:2px solid #22c55e; opacity:1 }
    .nav { position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none }
    .nav button { pointer-events:auto; all:unset; cursor:pointer; background:#00000066; color:#fff; padding:8px 10px; border-radius:10px; margin:8px }

    .info { padding:16px; display:flex; flex-direction:column; gap:8px }
    .x { all:unset; cursor:pointer; position:absolute; top:8px; right:10px; background:#00000066; color:#fff; padding:8px 10px; border-radius:10px }
    .title { font-size:22px; font-weight:800; margin:0 }
    .sku { font-size:12px; color:#64748b }
    .priceBig { font-weight:900; font-size:24px }
    .btn { padding:10px 14px; border:1px solid #e2e8f0; border-radius:999px; background:#0f172a; color:#fff; cursor:pointer }
    .btn.secondary { background:#fff; color:#0f172a }

    /* Panier (right column) */
    .cartBox { border:1px solid #e2e8f0; border-radius:12px; background:#fff; overflow:hidden }
    .cartRow { display:grid; grid-template-columns:28px 1fr auto auto 28px; gap:8px; align-items:center; padding:10px 12px; border-bottom:1px solid #e2e8f0 }
    .cartImg { width:44px; height:44px; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; background:#f1f5f9; display:flex; align-items:center; justify-content:center }
    .cartImg img { width:100%; height:100%; object-fit:cover }
    .qtyBtn { width:26px; height:26px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; cursor:pointer }
    .delBtn { all:unset; cursor:pointer; color:#ef4444; text-align:center }
    .totalBar { padding:12px; border-top:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center }

    /* Checkout modal (form) */
    .cbox { width:min(560px,100%); background:#fff; color:#0f172a; border-radius:16px; border:1px solid #e2e8f0; padding:14px }
    .rowf { display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .rowf + .rowf { margin-top:10px }
    label { font-size:12px; color:#64748b }
    input, select, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #e2e8f0; background:#fff; color:#0f172a }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px }
    .muted { color:#64748b; font-size:12px }
  </style>
</head>
<body>
  <header>
    <div class="brand">GYMCO.MA</div>
    <nav>
      <a href="index.html">Catalog</a>
      <a href="admin.html">Admin</a>
    </nav>
  </header>

  <main style="display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start;max-width:1200px">
    <!-- LEFT: CATALOG -->
    <section>
      <h1>Bienvenue ðŸ‘‹</h1>
      <p>Cocher rapidement les produits Ã  commander. Cliquez sur une carte (pas la case) pour voir la galerie.</p>

      <!-- PRODUCTS GRID -->
      <div id="grid" class="grid"></div>
      <p class="small" style="color:#64748b">Astuce: utilisez les cases pour sÃ©lectionner vite 10+ produits.</p>
    </section>

    <!-- RIGHT: PANIER (same page) -->
    <aside id="panier" style="position:sticky;top:12px">
      <div class="cartBox">
        <div style="padding:12px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center">
          <strong>Panier</strong>
          <label style="display:flex;align-items:center;gap:8px;font-size:14px">
            <input type="checkbox" id="checkAll">
            <span>Tout sÃ©lectionner</span>
          </label>
        </div>

        <div id="cartList"></div>

        <div class="totalBar">
          <div>
            <div class="small">Total sÃ©lectionnÃ©</div>
            <div id="cartTotal" style="font-weight:900;font-size:20px">0 DH</div>
          </div>
          <button class="btn" id="checkoutBtn">Commander (COD)</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- PRODUCT MODAL -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Produit">
    <div class="box">
      <button class="x" id="closeModal" aria-label="Fermer">âœ•</button>

      <section class="gal">
        <div class="hero"><img id="heroImg" alt="Image produit" /></div>
        <div class="nav">
          <button id="prev" aria-label="PrÃ©cÃ©dent">â—€</button>
          <button id="next" aria-label="Suivant">â–¶</button>
        </div>
        <div class="thumbs" id="thumbs"></div>
      </section>

      <section class="info">
        <h2 class="title" id="mTitle"></h2>
        <div class="sku" id="mSku"></div>
        <div class="priceBig" id="mPrice"></div>
        <p id="mDesc"></p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" id="addToCart">Ajouter au panier</button>
          <button class="btn secondary" id="buyNow">Acheter</button>
        </div>
      </section>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal" aria-modal="true" role="dialog" aria-label="Commander">
    <div class="cbox">
      <button class="x" id="closeCheckout" aria-label="Fermer" style="float:right">âœ•</button>
      <h2 style="margin-top:0">Finaliser la commande</h2>
      <p class="muted">Veuillez remplir vos informations. Choisissez ensuite **Confirmer par appel** ou **Confirmer par WhatsApp**.</p>

      <div class="rowf">
        <div>
          <label>Nom complet</label>
          <input id="c_name" placeholder="Ex: Youssef Benali">
        </div>
        <div>
          <label>Ville</label>
          <input id="c_city" placeholder="Ex: Casablanca">
        </div>
      </div>
      <div class="rowf">
        <div>
          <label>TÃ©lÃ©phone</label>
          <input id="c_phone" placeholder="Ex: 0612 34 56 78">
        </div>
        <div>
          <label>Remarque (optionnel)</label>
          <input id="c_note" placeholder="Taille, couleurâ€¦">
        </div>
      </div>

      <div style="margin-top:10px">
        <label>RÃ©sumÃ©</label>
        <textarea id="c_summary" readonly style="min-height:110px"></textarea>
      </div>

      <div class="actions">
        <button class="btn" id="confirmCall">Confirmer par appel</button>
        <button class="btn secondary" id="confirmWhatsApp">Confirmer par WhatsApp</button>
      </div>
    </div>
  </div>

  <script>
    // ======= CONFIGURE THESE =======
    const WHATSAPP_NUMBER = '212623126364'; // your phone without '+'
    const ZAPIER_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/XXXXXXX/YYYYYYY/'; // replace with your Zap URL
    // ================================

    // -------- Load products from products.json --------
    let products = [];

    async function loadProducts(){
      try {
        const res = await fetch('products.json', { cache: 'no-store' });
        products = await res.json();
      } catch (e) {
        console.error('Failed to load products.json', e);
        products = [];
      }
    }

    // -------- Cart helpers --------
    function getCart(){ return JSON.parse(localStorage.getItem('cart')||'[]'); }
    function setCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }
    function inCart(id){ return getCart().some(x=>x.id===id); }
    function addItem(p){
      const cart = getCart();
      const ex = cart.find(x=>x.id===p.id);
      if (ex) {
        ex.qty = (ex.qty||1) + 1;
      } else {
        cart.push({ id:p.id, name:p.name, price:p.price, currency:p.currency||'DH', qty:1, cover:p.cover||'' });
      }
      setCart(cart);
      renderCart();
    }
    function removeItem(id){
      const cart = getCart().filter(x=>x.id!==id);
      setCart(cart);
      renderCart();
    }

    // -------- Render grid (with checkboxes) --------
    async function renderGrid(){
      await loadProducts();
      const $grid = document.getElementById('grid');
      const cartIds = new Set(getCart().map(x=>x.id));
      if (!products.length){
        $grid.innerHTML = '<p class="small">Aucun produit. Ã‰ditez <code>products.json</code>.</p>';
        return;
      }
      $grid.innerHTML = products.map(p => `
        <article class="card" data-id="${p.id}">
          <div class="pickwrap" data-stop>
            <input type="checkbox" class="pick" ${cartIds.has(p.id)?'checked':''} title="SÃ©lection rapide">
          </div>
          <div class="img"><img src="${p.cover}" alt="${p.name}"></div>
          <div class="small">ID: ${p.id}</div>
          <div style="font-weight:700">${p.name}</div>
          <div class="price">${Number(p.price).toLocaleString('fr-MA')} ${p.currency || 'DH'}</div>
        </article>
      `).join('');
    }

    // ===== Panier (same page) =====
    const $cartList = document.getElementById('cartList');
    const $cartTotal = document.getElementById('cartTotal');
    const $checkAll = document.getElementById('checkAll');

    function money(n){ return Number(n||0).toLocaleString('fr-MA') + ' DH'; }

    function renderCart(){
      const items = getCart();
      if (!items.length){
        $cartList.innerHTML = '<div style="padding:12px" class="small">Votre panier est vide.</div>';
        $checkAll.checked = false;
        updateCartTotal();
        document.querySelectorAll('.card .pick').forEach(ch => ch.checked = false);
        return;
      }
      $cartList.innerHTML = items.map((p, i) => `
        <div class="cartRow row" data-i="${i}">
          <input type="checkbox" class="chk" checked />
          <div style="display:flex;align-items:center;gap:8px">
            <div class="cartImg">${p.cover?`<img src="${p.cover}" alt="${p.name}">`:'â€”'}</div>
            <div>
              <div class="name" style="font-weight:700;font-size:14px">${p.name}</div>
              <div class="id small">ID: ${p.id}</div>
            </div>
          </div>
          <div class="qty" style="display:flex;align-items:center;gap:6px">
            <button class="qtyBtn minus">âˆ’</button>
            <span>${p.qty||1}</span>
            <button class="qtyBtn plus">+</button>
          </div>
          <div class="price" style="font-weight:900">${money((p.qty||1)*p.price)}</div>
          <button class="delBtn del" title="Supprimer">âœ•</button>
        </div>
      `).join('');

      const ids = new Set(items.map(x=>x.id));
      document.querySelectorAll('.card').forEach(card=>{
        const id = card.getAttribute('data-id');
        const pick = card.querySelector('.pick');
        if (pick) pick.checked = ids.has(id);
      });

      syncSelectAll();
      updateCartTotal();
    }

    function syncSelectAll(){
      const chks = Array.from(document.querySelectorAll('#cartList .chk'));
      if (!chks.length) { $checkAll.checked = false; return; }
      $checkAll.checked = chks.every(c => c.checked);
    }

    function updateCartTotal(){
      const items = getCart();
      const rows = Array.from(document.querySelectorAll('#cartList .row'));
      const sum = rows.reduce((total, row) => {
        const i = Number(row.getAttribute('data-i'));
        const chk = row.querySelector('.chk');
        if (!chk || !chk.checked) return total;
        const it = items[i];
        return total + (it.price * (it.qty||1));
      }, 0);
      $cartTotal.textContent = money(sum);
    }

    // Grid events
    document.getElementById('grid').addEventListener('change', (e)=>{
      if (!e.target.classList.contains('pick')) return;
      const card = e.target.closest('.card');
      const id = card.getAttribute('data-id');
      const p = products.find(x=>x.id===id);
      if (!p) return;
      if (e.target.checked) addItem(p); else removeItem(p.id);
    });

    document.getElementById('grid').addEventListener('click', (e)=>{
      if (e.target.closest('.pickwrap')) return;
      const card = e.target.closest('.card'); if (!card) return;
      const id = card.getAttribute('data-id');
      const p = products.find(x=>x.id===id);
      if (p) openModal(p);
    });

    // Cart events
    $cartList.addEventListener('click', (e)=>{
      const row = e.target.closest('.row'); if (!row) return;
      const i = Number(row.getAttribute('data-i'));
      const items = getCart();
      const it = items[i];

      if (e.target.classList.contains('plus')){
        it.qty = (it.qty||1) + 1;
        setCart(items); renderCart(); return;
      }
      if (e.target.classList.contains('minus')){
        it.qty = Math.max(1, (it.qty||1) - 1);
        setCart(items); renderCart(); return;
      }
      if (e.target.classList.contains('del')){
        const removedId = it.id;
        items.splice(i,1);
        setCart(items); renderCart();
        const cardPick = document.querySelector(`.card[data-id="${removedId}"] .pick`);
        if (cardPick) cardPick.checked = false;
        return;
      }
    });

    $cartList.addEventListener('change', (e)=>{
      if (e.target.classList.contains('chk')){
        updateCartTotal();
        syncSelectAll();
      }
    });

    $checkAll?.addEventListener('change', ()=>{
      document.querySelectorAll('#cartList .chk').forEach(ch => ch.checked = $checkAll.checked);
      updateCartTotal();
    });

    // -------- Checkout modal flow --------
    const $checkoutModal = document.getElementById('checkoutModal');
    const $closeCheckout = document.getElementById('closeCheckout');
    const $cName = document.getElementById('c_name');
    const $cCity = document.getElementById('c_city');
    const $cPhone = document.getElementById('c_phone');
    const $cNote = document.getElementById('c_note');
    const $cSummary = document.getElementById('c_summary');

    function openCheckout(){
      const rows = Array.from(document.querySelectorAll('#cartList .row'));
      const items = getCart();
      const selected = rows.map(row=>{
        const i = Number(row.getAttribute('data-i'));
        const chk = row.querySelector('.chk');
        return chk && chk.checked ? items[i] : null;
      }).filter(Boolean);

      if (!selected.length){ alert('SÃ©lectionnez au moins un article.'); return; }

      // Build readable summary
      const names = selected.map(x=>x.name).join(' + ');
      const prices = selected.map(x=>x.price).join(' + ');
      const total = selected.reduce((a,b)=>a + (b.price*(b.qty||1)), 0);

      $cSummary.value =
`Produits : ${names}
Prix : ${prices}
Total : ${Number(total).toLocaleString('fr-MA')} DH`;

      $checkoutModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeCheckout(){
      $checkoutModal.classList.remove('open');
      document.body.style.overflow = 'auto';
    }

    document.getElementById('checkoutBtn')?.addEventListener('click', openCheckout);
    $closeCheckout.addEventListener('click', closeCheckout);
    $checkoutModal.addEventListener('click', e=>{ if (e.target === $checkoutModal) closeCheckout(); });
    document.addEventListener('keydown', e=>{ if (e.key==='Escape') closeCheckout(); });

    function collectOrder(){
      const rows = Array.from(document.querySelectorAll('#cartList .row'));
      const items = getCart();
      const selected = rows.map(row=>{
        const i = Number(row.getAttribute('data-i'));
        const chk = row.querySelector('.chk');
        return chk && chk.checked ? items[i] : null;
      }).filter(Boolean);

      const total = selected.reduce((a,b)=>a + (b.price*(b.qty||1)), 0);
      return {
        customer: {
          name: $cName.value.trim(),
          city: $cCity.value.trim(),
          phone: $cPhone.value.trim(),
          note: $cNote.value.trim()
        },
        items: selected,
        total
      };
    }

    function validateCustomer(c){
      if (!c.name || !c.city || !c.phone) return false;
      return c.phone.replace(/\D/g,'').length >= 9; // basic check
    }

    // Confirm by CALL (send to Zapier webhook)
    document.getElementById('confirmCall').addEventListener('click', async ()=>{
      const order = collectOrder();
      if (!validateCustomer(order.customer)){
        alert('Nom, Ville et TÃ©lÃ©phone obligatoires (tÃ©lÃ©phone valide).');
        return;
      }
      try {
        await fetch(ZAPIER_WEBHOOK_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ type:'lead_call', order })
        });
        alert('âœ… Demande envoyÃ©e. Nous vous appellerons pour confirmer.');
        closeCheckout();
      } catch(e){
        alert("Ã‰chec d'envoi. VÃ©rifiez le webhook.");
      }
    });

    // Confirm by WHATSAPP (open with prefilled message)
    document.getElementById('confirmWhatsApp').addEventListener('click', ()=>{
      const order = collectOrder();
      if (!validateCustomer(order.customer)){
        alert('Nom, Ville et TÃ©lÃ©phone obligatoires (tÃ©lÃ©phone valide).');
        return;
      }
      const names = order.items.map(x=>x.name).join(' + ');
      const prices = order.items.map(x=>x.price).join(' + ');
      const total = Number(order.total).toLocaleString('fr-MA');

      const msg =
`Bonjour, je veux confirmer une commande :

Produits : ${names}
Prix : ${prices}
Total : ${total} DH

Nom : ${order.customer.name}
Ville : ${order.customer.city}
TÃ©lÃ©phone : ${order.customer.phone}
Note : ${order.customer.note || '-'}`;

      const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    });

    // -------- Product modal logic --------
    const $modal = document.getElementById('modal');
    const $heroImg = document.getElementById('heroImg');
    const $thumbs = document.getElementById('thumbs');
    const $mTitle = document.getElementById('mTitle');
    const $mSku = document.getElementById('mSku');
    const $mPrice = document.getElementById('mPrice');
    const $mDesc = document.getElementById('mDesc');
    const $close = document.getElementById('closeModal');
    const $add = document.getElementById('addToCart');
    const $buy = document.getElementById('buyNow');
    const $prev = document.getElementById('prev');
    const $next = document.getElementById('next');

    let current = null;
    let idx = 0;

    function openModal(p){
      current = p; idx = 0;
      $mTitle.textContent = p.name;
      $mSku.textContent = 'ID: ' + p.id;
      $mPrice.textContent = Number(p.price).toLocaleString('fr-MA') + ' ' + (p.currency || 'DH');
      $mDesc.textContent = p.desc || '';
      renderGallery();
      $modal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      $modal.classList.remove('open');
      document.body.style.overflow = 'auto';
    }
    function renderGallery(){
      const imgs = current.images?.length ? current.images : [current.cover];
      idx = Math.max(0, Math.min(idx, imgs.length-1));
      $heroImg.src = imgs[idx];
      $heroImg.alt = `${current.name} â€“ image ${idx+1}`;
      $thumbs.innerHTML = imgs.map((src,i)=>`<img src="${src}" alt="miniature ${i+1}" data-i="${i}" class="${i===idx?'active':''}">`).join('');
    }

    document.getElementById('grid').addEventListener('click', e=>{
      // handled above for checkbox vs. card; this is kept for clarity
    });

    $close.addEventListener('click', closeModal);
    $modal.addEventListener('click', e=>{ if (e.target === $modal) closeModal(); });
    document.addEventListener('keydown', e=>{ if (e.key==='Escape') closeModal(); });

    $thumbs.addEventListener('click', e=>{
      const im = e.target.closest('img'); if (!im) return;
      idx = Number(im.dataset.i)||0; renderGallery();
    });

    $prev.addEventListener('click', ()=>{ idx = (idx-1+current.images.length)%current.images.length; renderGallery(); });
    $next.addEventListener('click', ()=>{ idx = (idx+1)%current.images.length; renderGallery(); });

    let startX=null;
    $heroImg.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; });
    $heroImg.addEventListener('touchend', e=>{
      if (startX===null) return;
      const dx = e.changedTouches[0].clientX - startX;
      startX=null;
      if (Math.abs(dx)<40) return;
      if (dx>0) $prev.click(); else $next.click();
    });

    // actions in product modal
    $add.addEventListener('click', ()=>{ if (current) { addItem(current); } });
    $buy.addEventListener('click', ()=>{ if (current) { addItem(current); } });

    // Kick off
    awaitInit();
    async function awaitInit(){
      await renderGrid();
      renderCart();
    }
  </script>
</body>
</html>
